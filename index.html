<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="title">Dashboard Real Time Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/id.min.js"></script>
    <style>
        /* === CSS ASLI ANDA === */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(100deg, #0f2027 10%, #203a43 50%, #22404e 100%);
            color: #fff;
            line-height: 1;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px; 
            margin: 0 auto;
        }
        
        header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin-right: 20px;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .header-text {
            flex: 1;
        }
        
        h1 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .description {
            color: #a0d2eb;
            font-size: 1.1rem;
        }
        
        /* === KONTROL UTAMA: MEMISAHKAN FILTER DAN REFRESH === */
        .controls {
            display: flex;
            justify-content: space-between; 
            flex-wrap: wrap; 
            gap: 15px; 
            align-items: center;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        #reloadGroup {
            display: flex;
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            margin-left: auto;
        }
        
        .refresh-status {
            display: flex;
            align-items: center;
            color: #2ecc71;
            font-weight: 600;
            font-size: 0.9rem; 
        }
        
        .refresh-status::before {
            content: "";
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #2ecc71;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        button {
            padding: 8px 15px;
            background: linear-gradient(135deg, #00b4db 0%, #0083b0 100%);
            color: white;
            border: none;
            border-radius: 7.5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            font-weight: 600;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #0083b0 0%, #00b4db 100%);
        }

        /* === GAYA TOMBOL BAHASA & ADMIN === */
        .lang-toggle {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
            margin-left: 10px; /* Jarak antara toggle bahasa dan admin */
        }
        .lang-toggle:hover {
            background: #2980b9;
        }
        /* === END GAYA TOMBOL BAHASA & ADMIN === */
        
        /* === GAYA FILTER === */
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group select,
        .custom-range input[type="date"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #0f2027; 
            cursor: pointer;
            font-size: 1rem;
            outline: none;
        }
        
        .filter-group label {
            font-weight: 500;
            color: #fff;
        }
        
        .custom-range button {
            padding: 8px 15px;
        }
        /* === END GAYA FILTER === */

        /* === GAYA MODAL/POPUP BARU === */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); 
            padding-top: 60px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            color: #fff;
        }

        .close-button {
            color: #fff;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #ccc;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content input[type="text"],
        .modal-content input[type="password"],
        .modal-content input[type="number"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0 15px 0;
            display: inline-block;
            border: none;
            border-radius: 8px;
            background: #f1f1f1;
            color: #0f2027;
        }
        
        .modal-content button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }

        .setting-group {
            margin-bottom: 15px;
        }
        .setting-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #a0d2eb;
        }

        .reset-btn {
            background: #c0392b !important; /* Merah untuk reset */
        }
        .save-btn {
            background: #27ae60 !important; /* Hijau untuk simpan */
        }
        /* --- END GAYA MODAL/POPUP BARU --- */

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 10px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h3 {
            color: #a0d2eb;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }
        
        .stat-subvalue {
            font-size: 0.9rem;
            color: #a0d2eb;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .chart-wrapper {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            color: #fff;
            font-size: 1.3rem;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        
        .data-table-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }

        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        .table-controls .left,
        .table-controls .right {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .table-controls input,
        .table-controls select {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            outline: none;
            color: #0f2027;
        }
        .export-btn { background: #27ae60; }

        .table-wrapper {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th, .data-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table th {
            background-color: rgba(0, 132, 255, 1);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
        }

        .data-table th .sort-indicator {
            margin-left: 6px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .data-table tr:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .status-normal {
            background-color: rgba(46, 204, 113, 0.3);
            color: #2ecc71;
        }
        
        .status-lower {
            background-color: rgba(255, 165, 0, 0.3);
            color: #ffa500;
        }
        
        .status-over {
            background-color: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #a0d2eb;
        }
        
        .last-updated {
            text-align: right;
            margin-top: 15px;
            color: #a0d2eb;
            font-size: 0.9rem;
        }

        .pagination {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 6px 12px;
            background: #2980b9;
            font-size: 0.9rem;
        }
        .pagination button.active { background: #16a085; }
        
        /* Scrollbar styling */
        .table-wrapper::-webkit-scrollbar { width: 8px; }
        .table-wrapper::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; }
        .table-wrapper::-webkit-scrollbar-thumb { background: rgba(0, 132, 255, 0.5); border-radius: 4px; }
        .table-wrapper::-webkit-scrollbar-thumb:hover { background: rgba(0, 132, 255, 0.7); }
        
        @media (max-width: 1024px) {
            .charts-container { grid-template-columns: 1fr; }
        }
        
        /* === MEDIA QUERY UNTUK MOBILE (PENTING) === */
        @media (max-width: 768px) {
            .stats-cards { grid-template-columns: 1fr 1fr; }
            header { flex-direction: column; text-align: center; }
            .logo { margin-right: 0; margin-bottom: 15px; }
            .stat-value { font-size: 1.8rem; }
            .data-table th, .data-table td { padding: 10px; font-size: 0.9rem; }
            
            /* Mengubah Kontrol kembali ke tata letak kolom agar rapi di layar kecil */
            .controls, .table-controls { 
                flex-direction: column; 
                align-items: stretch; /* Mengambil lebar penuh */
            }
            .filter-group, .custom-range, .table-controls .left, .table-controls .right { 
                flex-direction: column; 
                align-items: stretch;
                width: 100%;
            }
            .filter-group select, .custom-range input, .custom-range button { width: 100%; }
            .table-controls input, .table-controls select, .export-btn { width: 100%; }

            /* Menghapus dorongan 'margin-left: auto' agar tombol berada di tengah */
            #reloadGroup {
                flex-direction: column;
                align-items: center; /* Tetap pusatkan tombol dan teks di tengah */
                width: 100%;
                margin-left: 0; 
            }

            .modal-content {
                margin-top: 30px;
                width: 95%;
            }
        }
        /* === END MEDIA QUERY === */
        
        @media (max-width: 480px) {
            .stats-cards { grid-template-columns: 1fr; }
            .stat-value { font-size: 1.6rem; }
            .data-table th, .data-table td { padding: 8px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="https://raw.githubusercontent.com/Ariyanto92/esp32-assets/b51d45111c451a3522a8eb6f642587893afa9c11/logo1.png" alt="Logo ARAYA Tech">
            </div>
            <div class="header-text">
                <h1 data-key="mainTitle">Dashboard Real Time Monitoring</h1>
                <p class="description" data-key="subTitle">Monitoring Real-time Production</p>
            </div>
            <div class="lang-toggle" id="languageToggle">English</div>
            <div class="lang-toggle" id="adminLoginToggle">Admin</div>
        </header>
        
        <div class="controls">
            <div class="filter-group">
                <label for="datePreset" data-key="filterLabel">Filter Data:</label>
                <select id="datePreset">
                    <option value="today" data-key="filterToday">Hari ini</option>
                    <option value="yesterday" data-key="filterYesterday">Kemarin</option>
                    <option value="currentWeek" data-key="filterWeek">Minggu ini</option>
                    <option value="currentMonth" data-key="filterMonth">Bulan ini</option>
                    <option value="all" data-key="filterAll" selected>Semua Data</option>
                    <option value="custom" data-key="filterCustom">Kustom (Range Tanggal)</option>
                </select>
            </div>
            <div class="custom-range" id="customRangeControls" style="display: none;">
                <input type="date" id="startDate" title="Tanggal Mulai">
                <input type="date" id="endDate" title="Tanggal Akhir">
                <button id="applyFilterBtn" data-key="filterApplyBtn">Terapkan</button>
            </div>
            <div id="reloadGroup">
                <button id="loadData" data-key="reloadButton">⟳ Muat Ulang Data</button>
                <div class="refresh-status" data-key="refreshStatus">Auto Refresh (2 detik)</div>
            </div>
            </div>
        
        <div class="stats-cards">
            <div class="stat-card">
                <h3 data-key="statAvgCycle">RATA-RATA CYCLE TIME</h3>
                <div class="stat-value" id="avgCycleTime">40.75s</div>
                <div class="stat-subvalue"><span data-key="statTarget">Target</span>: 60.00s</div>
            </div>
            <div class="stat-card">
                <h3 data-key="statTotalCycles">TOTAL CYCLE</h3>
                <div class="stat-value" id="totalCycles">270</div>
                <div class="stat-subvalue" data-key="statToday">Hari ini: 24</div>
            </div>
            <div class="stat-card">
                <h3 data-key="statLastCycle">CYCLE TIME TERAKHIR</h3>
                <div class="stat-value" id="lastCycleTime">38.42s</div>
                <div class="stat-subvalue" id="lastCycleStatus" data-key="statStatusPrefix">Status: NORMAL</div>
            </div>
            <div class="stat-card">
                <h3 data-key="statMinCycle">CYCLE TIME TERCEPAT</h3>
                <div class="stat-value" id="minCycleTime">0.00s</div>
                <div class="stat-subvalue" data-key="statMaxCycle">Terlama: 1612.34s</div>
            </div>
        </div>
        
        <div class="charts-container">
            <div class="chart-wrapper">
                <h2 class="chart-title" data-key="chartTitle1">GRAFIK CYCLE TIME</h2>
                <div class="chart-container">
                    <canvas id="cycleTimeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <h2 class="chart-title" data-key="chartTitle2">STATUS</h2>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="data-table-container">
            <h2 class="chart-title" data-key="tableTitle">DATA CYCLE TIME</h2>

            <div class="table-controls">
                <div class="left">
                    <input type="text" id="searchInput" placeholder="Cari data (tanggal, cycle, status)..." data-key-placeholder="searchPlaceholder">
                    <select id="rowsPerPage">
                        <option value="10" data-key-select="rowsPerPage">10 / halaman</option>
                        <option value="25" data-key-select="rowsPerPage">25 / halaman</option>
                        <option value="50" data-key-select="rowsPerPage">50 / halaman</option>
                        <option value="100" data-key-select="rowsPerPage">100 / halaman</option>
                    </select>
                </div>
                <div class="right">
                    <button class="export-btn" id="exportCsvBtn" data-key="exportButton">⬇ Export CSV</button>
                </div>
            </div>
            <div id="tableContainer">
                <div class="loading" data-key="loadingMessage">Memuat data production...</div>
            </div>

            <div class="pagination" id="pagination"></div>
            <div class="last-updated" id="lastUpdated" data-key="lastUpdatedPrefix"></div>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 data-key="adminLoginTitle">Login Admin</h2>
            <input type="text" id="adminUsername" placeholder="Username">
            <input type="password" id="adminPassword" placeholder="Password">
            <button id="loginAdminBtn">Login</button>
            <p id="loginMessage" style="color: red; margin-top: 10px;"></p>

            <div id="adminControls" style="display: none; margin-top: 20px;">
                <h3 data-key="adminSettingsTitle">Pengaturan Batas Cycle Time</h3>
                
                <div class="setting-group">
                    <label for="newLowerLimit">Lower Limit (saat ini: <span id="currentLower"></span>s)</label>
                    <input type="number" id="newLowerLimit" min="1" step="0.01">
                </div>
                
                <div class="setting-group">
                    <label for="newUpperLimit">Upper Limit (saat ini: <span id="currentUpper"></span>s)</label>
                    <input type="number" id="newUpperLimit" min="1" step="0.01">
                </div>
                
                <button id="saveLimitsBtn" class="save-btn">Simpan Batas</button>
                <p id="limitMessage" style="color: green; margin-top: 10px;"></p>

                <h3 data-key="adminResetTitle" style="margin-top: 30px;">Reset Data Produksi</h3>
                <button id="resetDataBtn" class="reset-btn">⚠️ Reset SEMUA Data</button>
                <p style="font-size: 0.9em; color: yellow;">*Peringatan: Aksi ini tidak dapat dibatalkan.</p>
                <p id="resetMessage" style="color: green; margin-top: 10px;"></p>
            </div>
        </div>
    </div>
    <script>
    // ===== KAMUS TERJEMAHAN BARU + TAMBAHAN ADMIN =====
    const translations = {
        'id': {
            title: 'Dashboard Real Time Monitoring',
            mainTitle: 'Dashboard Real Time Monitoring',
            subTitle: 'Monitoring Real-time Production',
            reloadButton: '⟳ Muat Ulang Data',
            refreshStatus: 'Auto Refresh (2 detik)', 
            statAvgCycle: 'CT RATA-RATA',
            statTotalCycles: 'TOTAL CYCLE',
            statLastCycle: 'CT TERAKHIR',
            statMinCycle: 'CT TERCEPAT',
            statTarget: 'Target',
            statToday: 'Hari ini:',
            statMaxCycle: 'Terlama:',
            statStatusPrefix: 'Status:',
            chartTitle1: 'GRAFIK CYCLE TIME',
            chartTitle2: 'STATUS',
            tableTitle: 'DATA CYCLE TIME',
            searchPlaceholder: 'Cari data (tanggal, cycle, status)...',
            rowsPerPage: ' / halaman',
            exportButton: '⬇ Export CSV',
            loadingMessage: 'Memuat data production...',
            lastUpdatedPrefix: 'Terakhir diperbarui:',
            cycleTimeLabel: 'Waktu (detik)',
            cycleLabel: 'Cycle',
            limitLower: 'Lower Limit',
            limitUpper: 'Upper Limit',
            statusLower: 'LOWER',
            statusNormal: 'NORMAL',
            statusOver: 'OVER',
            statusToday: 'Hari ini:',
            statusLongest: 'Terlama:',
            tableStatus: 'Status',
            totalLabel: 'Total',
            tableHeader0: 'Timestamp',
            tableHeader1: 'Cycle Count',
            tableHeader2: 'Cycle Time',
            tableHeader3: 'Status',
            filterLabel: 'Filter Data:',
            filterToday: 'Hari ini',
            filterYesterday: 'Kemarin',
            filterWeek: 'Minggu ini',
            filterMonth: 'Bulan ini',
            filterAll: 'Semua Data',
            filterCustom: 'Kustom (Range Tanggal)',
            filterApplyBtn: 'Terapkan',
            // --- TERJEMAHAN ADMIN BARU ---
            adminLoginTitle: 'Login Admin',
            adminSettingsTitle: 'Pengaturan Batas Cycle Time',
            adminResetTitle: 'Reset Data Produksi',
        },
        'en': {
            title: 'Real Time Monitoring Dashboard',
            mainTitle: 'Real Time Monitoring Dashboard',
            subTitle: 'Real-time Production Monitoring',
            reloadButton: '⟳ Reload Data',
            refreshStatus: 'Auto Refresh (2 seconds)', 
            statAvgCycle: 'AVERAGE CT',
            statTotalCycles: 'TOTAL CYCLES',
            statLastCycle: 'LAST CT',
            statMinCycle: 'FASTEST CT',
            statTarget: 'Target',
            statToday: 'Today:',
            statMaxCycle: 'Longest:',
            statStatusPrefix: 'Status:',
            chartTitle1: 'CYCLE TIME CHART',
            chartTitle2: 'PRODUCTION STATUS',
            tableTitle: 'CYCLE TIME DATA',
            searchPlaceholder: 'Search data (date, cycle, status)...',
            rowsPerPage: ' / page',
            exportButton: '⬇ Export CSV',
            loadingMessage: 'Loading production data...',
            lastUpdatedPrefix: 'Last updated:',
            cycleTimeLabel: 'Time (seconds)',
            cycleLabel: 'Cycle',
            limitLower: 'Lower Limit',
            limitUpper: 'Upper Limit',
            statusLower: 'LOWER',
            statusNormal: 'NORMAL',
            statusOver: 'OVER',
            statusToday: 'Today:',
            statusLongest: 'Longest:',
            tableStatus: 'Status',
            totalLabel: 'Total',
            tableHeader0: 'Timestamp',
            tableHeader1: 'Cycle Count',
            tableHeader2: 'Cycle Time',
            tableHeader3: 'Status',
            filterLabel: 'Filter Data:',
            filterToday: 'Today',
            filterYesterday: 'Yesterday',
            filterWeek: 'This Week',
            filterMonth: 'This Month',
            filterAll: 'All Data',
            filterCustom: 'Custom (Date Range)',
            filterApplyBtn: 'Apply',
            // --- TERJEMAHAN ADMIN BARU ---
            adminLoginTitle: 'Admin Login',
            adminSettingsTitle: 'Cycle Time Limit Settings',
            adminResetTitle: 'Production Data Reset',
        }
    };

    // ===== FUNGSI TRANSLASI (Tidak ada perubahan) =====
    let currentLanguage = localStorage.getItem('lang') || 'id';

    function updateTextContent(lang) {
        document.querySelectorAll('[data-key]').forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang][key]) {
                el.textContent = translations[lang][key];
            }
        });
        document.querySelectorAll('[data-key-placeholder]').forEach(el => {
            const key = el.getAttribute('data-key-placeholder');
            if (translations[lang][key]) {
                el.placeholder = translations[lang][key];
            }
        });
        
        // Handle select options for rowsPerPage
        document.getElementById('rowsPerPage').querySelectorAll('option').forEach(opt => {
            const val = opt.value;
            opt.textContent = val + translations[lang].rowsPerPage;
        });

        // Handle select options for datePreset
        document.getElementById('datePreset').querySelectorAll('option').forEach(opt => {
            const key = 'filter' + opt.value.charAt(0).toUpperCase() + opt.value.slice(1).replace('current', '');
            if (translations[lang][key]) {
                opt.textContent = translations[lang][key];
            }
        });

        // Update Header Text Manually
        document.querySelector('h1').textContent = translations[lang].mainTitle;
        document.querySelector('.description').textContent = translations[lang].subTitle;

        // Update Button Toggle
        document.getElementById('languageToggle').textContent = lang === 'id' ? 'English' : 'Indonesia';
        
        // Update Moment.js locale
        moment.locale(lang);

        // Update Chart Labels 
        if (cycleTimeChart) {
            cycleTimeChart.options.scales.y.title.text = translations[lang].cycleTimeLabel;
            cycleTimeChart.options.scales.x.title.text = translations[lang].cycleLabel;
            cycleTimeChart.data.datasets[0].label = translations[lang].cycleTimeLabel.split(' ')[0] + ' (' + translations[lang].cycleTimeLabel.split(' ')[1].replace(/[()]/g, '') + ')';
            cycleTimeChart.data.datasets[1].label = translations[lang].limitLower + ` (${LOWER_LIMIT.toFixed(2)}s)`;
            cycleTimeChart.data.datasets[2].label = translations[lang].limitUpper + ` (${UPPER_LIMIT.toFixed(2)}s)`;
            cycleTimeChart.update();
        }

        // Update Table Headers 
        if (tableHeaders.length > 0) {
            tableHeaders = [
                translations[lang].tableHeader0,
                translations[lang].tableHeader1,
                translations[lang].tableHeader2,
                translations[lang].tableHeader3
            ];
            renderTable(false);
        }
    }

    // ===== KONFIGURASI + VARIABEL BARU ADMIN =====
    const SHEET_ID = '1rCXUBCO_Yo_QbVseleXOVxcTxBu2stqHolCzVHt2V38';
    const RANGE = 'Sheet1!A:D';
    const API_KEY = 'AIzaSyBBQrCTUEtB_4SDudVzmmcFRXLP614FZZc';

    // DIUBAH DARI CONST MENJADI LET AGAR BISA DIUBAH OLEH ADMIN
    let LOWER_LIMIT = 55;
    let UPPER_LIMIT = 65;

    // Konfigurasi Admin
    const ADMIN_USERNAME = 'admin'; 
    const ADMIN_PASSWORD = '123';   
    let isLoggedIn = false;
    
    let cycleTimeChart;
    let statusChart;
    let autoRefreshInterval;

    let tableHeaders = [];
    let tableRowsAll = []; 
    let currentPage = 1;
    let rowsPerPage = 10;
    let currentSortIndex = null;
    let sortDirection = 'asc';

    let filterStartDate = null; 
    let filterEndDate = null; 

    // ===== INISIALISASI & EVENT LISTENER (Ditambahkan Admin Listeners) =====
    document.addEventListener('DOMContentLoaded', function() {
        updateTextContent(currentLanguage);
        
        // Event listener untuk tombol toggle bahasa
        document.getElementById('languageToggle').addEventListener('click', () => {
            currentLanguage = currentLanguage === 'id' ? 'en' : 'id';
            localStorage.setItem('lang', currentLanguage);
            updateTextContent(currentLanguage);
            if (tableRowsAll.length > 0) {
                 const lowerCount = tableRowsAll.filter(r => (parseFloat(r[2]) || 0) < LOWER_LIMIT).length;
                 const normalCount = tableRowsAll.filter(r => (parseFloat(r[2]) || 0) >= LOWER_LIMIT && (parseFloat(r[2]) || 0) <= UPPER_LIMIT).length;
                 const overCount = tableRowsAll.filter(r => (parseFloat(r[2]) || 0) > UPPER_LIMIT).length;
                 updateCharts([], lowerCount, normalCount, overCount);
            }
        });

        moment.locale(currentLanguage);
        initCharts();
        
        setFilterRange('all');
        loadDataFromSheets(); 
        
        document.getElementById('loadData').addEventListener('click', loadDataFromSheets);

        // === LISTENER KONTROL FILTER ===
        document.getElementById('datePreset').addEventListener('change', function(e) {
            const preset = e.target.value;
            const customControls = document.getElementById('customRangeControls');
            
            if (preset === 'custom') {
                customControls.style.display = 'flex';
                filterStartDate = null;
                filterEndDate = null;
            } else {
                customControls.style.display = 'none';
                setFilterRange(preset);
                
                if (tableRowsAll.length > 0) {
                    processData(tableRowsAll); 
                } else {
                    loadDataFromSheets();
                }
            }
        });

        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            
            if (start && end) {
                setFilterRange('custom', start, end);
                
                if (tableRowsAll.length > 0) {
                    processData(tableRowsAll);
                } else {
                    loadDataFromSheets();
                }
            } else {
                alert(currentLanguage === 'id' ? "Mohon masukkan Tanggal Mulai dan Tanggal Akhir." : "Please enter both Start Date and End Date.");
            }
        });
        // === END LISTENER KONTROL FILTER ===

        // === LISTENER KONTROL TABEL ===
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            renderTable();
        });
        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            rowsPerPage = parseInt(e.target.value, 10);
            currentPage = 1;
            renderTable();
        });
        document.getElementById('exportCsvBtn').addEventListener('click', exportCurrentToCSV);
        
        // Timer auto refresh
        autoRefreshInterval = setInterval(loadDataFromSheets, 2000); // 2000ms = 2 detik

        // === LISTENER KONTROL ADMIN BARU ===
        const adminModal = document.getElementById('adminModal');
        const adminToggle = document.getElementById('adminLoginToggle');
        const closeBtn = adminModal.querySelector('.close-button');
        const loginBtn = document.getElementById('loginAdminBtn');
        const resetBtn = document.getElementById('resetDataBtn');
        const saveLimitsBtn = document.getElementById('saveLimitsBtn');

        // Buka Modal Admin
        adminToggle.onclick = function() {
            // Perbarui nilai batas yang tampil
            document.getElementById('currentLower').textContent = LOWER_LIMIT.toFixed(2);
            document.getElementById('currentUpper').textContent = UPPER_LIMIT.toFixed(2);
            document.getElementById('newLowerLimit').value = LOWER_LIMIT;
            document.getElementById('newUpperLimit').value = UPPER_LIMIT;

            // Tampilkan/Sembunyikan menu berdasarkan status login
            document.getElementById('adminControls').style.display = isLoggedIn ? 'block' : 'none';
            loginBtn.style.display = isLoggedIn ? 'none' : 'block';
            adminModal.style.display = 'block';
        }

        // Tutup Modal
        closeBtn.onclick = function() {
            adminModal.style.display = 'none';
        }
        window.onclick = function(event) {
            if (event.target == adminModal) {
                adminModal.style.display = 'none';
            }
        }
        
        // --- Otentikasi Login ---
        loginBtn.onclick = function() {
            const user = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPassword').value;
            const msg = document.getElementById('loginMessage');

            if (user === ADMIN_USERNAME && pass === ADMIN_PASSWORD) {
                isLoggedIn = true;
                msg.textContent = currentLanguage === 'id' ? "Login Berhasil!" : "Login Successful!";
                msg.style.color = 'green';
                
                document.getElementById('adminControls').style.display = 'block';
                loginBtn.style.display = 'none';
            } else {
                msg.textContent = currentLanguage === 'id' ? "Username atau password salah." : "Incorrect username or password.";
                msg.style.color = 'red';
                isLoggedIn = false;
            }
        }

        // --- Simpan Batas Limit ---
        saveLimitsBtn.onclick = function() {
            if (!isLoggedIn) return;
            const newLower = parseFloat(document.getElementById('newLowerLimit').value);
            const newUpper = parseFloat(document.getElementById('newUpperLimit').value);
            const limitMsg = document.getElementById('limitMessage');

            if (isNaN(newLower) || isNaN(newUpper) || newLower <= 0 || newUpper <= newLower) {
                limitMsg.textContent = currentLanguage === 'id' ? "Batas tidak valid. Pastikan Upper > Lower." : "Invalid limits. Ensure Upper > Lower.";
                limitMsg.style.color = 'red';
                return;
            }

            updateLimits(newLower, newUpper);
            limitMsg.textContent = currentLanguage === 'id' ? `Batas berhasil diperbarui!` : `Limits updated successfully!`;
            limitMsg.style.color = 'green';
            setTimeout(() => { limitMsg.textContent = ''; }, 3000);
            
            document.getElementById('currentLower').textContent = newLower.toFixed(2);
            document.getElementById('currentUpper').textContent = newUpper.toFixed(2);
            
            // Perbarui label batas di chart
            if (cycleTimeChart) {
                updateTextContent(currentLanguage);
            }
        }

        // --- Reset Data ---
        resetBtn.onclick = function() {
            if (!isLoggedIn) return;

            const confirmation = confirm(currentLanguage === 'id' ? "ANDA YAKIN INGIN MERESET SEMUA DATA PRODUKSI? Aksi ini tidak dapat dibatalkan." : "ARE YOU SURE YOU WANT TO RESET ALL PRODUCTION DATA? This action cannot be undone.");
            
            if (confirmation) {
                resetAllData();
                document.getElementById('resetMessage').textContent = currentLanguage === 'id' ? "Permintaan Reset Data berhasil dikirim (Simulasi: Perlu API tulis)." : "Data Reset request sent (Simulation: Write API needed).";
                document.getElementById('resetMessage').style.color = 'green';
                setTimeout(() => { document.getElementById('resetMessage').textContent = ''; }, 5000);
            }
        }
    });
    // ===== END INISIALISASI & EVENT LISTENER =====

    // ===== FUNGSI SET FILTER RANGE (Tidak ada perubahan) =====
    function setFilterRange(preset, start = null, end = null) {
        const now = moment().startOf('day'); 
        filterStartDate = null;
        filterEndDate = null;

        if (preset === 'today') {
            filterStartDate = moment(now);
            filterEndDate = moment(now).endOf('day');
        } else if (preset === 'yesterday') {
            filterStartDate = moment(now).subtract(1, 'days').startOf('day');
            filterEndDate = moment(now).subtract(1, 'days').endOf('day');
        } else if (preset === 'currentWeek') {
            filterStartDate = moment(now).startOf('week');
            filterEndDate = moment(now).endOf('day');
        } else if (preset === 'currentMonth') {
            filterStartDate = moment(now).startOf('month');
            filterEndDate = moment(now).endOf('day');
        } else if (preset === 'custom' && start && end) {
            filterStartDate = moment(start).startOf('day');
            filterEndDate = moment(end).endOf('day');
        } 
    }
    // ===== END FUNGSI SET FILTER RANGE =====

    // ===== FUNGSI INIT CHART (Diperbarui dengan LOWER/UPPER LIMIT dari variabel 'let') =====
    function initCharts() {
        const ctx = document.getElementById('cycleTimeChart').getContext('2d');
        const lang = currentLanguage;
        cycleTimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: translations[lang].cycleTimeLabel.split(' ')[0] + ' (' + translations[lang].cycleTimeLabel.split(' ')[1].replace(/[()]/g, '') + ')',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(75, 192, 192, 1)'
                    },
                    {
                        label: translations[lang].limitLower + ` (${LOWER_LIMIT.toFixed(2)}s)`,
                        data: [],
                        borderColor: 'red',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: translations[lang].limitUpper + ` (${UPPER_LIMIT.toFixed(2)}s)`,
                        data: [],
                        borderColor: 'red',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: translations[lang].cycleTimeLabel,
                            color: '#a0d2eb'
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#a0d2eb' }
                    },
                    x: {
                        title: {
                            display: true,
                            text: translations[lang].cycleLabel,
                            color: '#a0d2eb'
                        },
                        grid: { display: false },
                        ticks: { color: '#a0d2eb' }
                    }
                },
                plugins: {
                    legend: { labels: { color: '#a0d2eb' } }
                }
            }
        });
        
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        statusChart = new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: [translations[lang].statusLower, translations[lang].statusNormal, translations[lang].statusOver],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 165, 0, 0.8)',
                        'rgba(46, 204, 113, 0.8)',
                        'rgba(231, 76, 60, 0.8)'
                    ],
                    borderColor: [
                        'rgba(255, 165, 0, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(231, 76, 60, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#a0d2eb', font: { size: 14 } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + "%" : "0%";
                                return context.label.split(':')[0] + ": " + value + " (" + percentage + ")"; 
                            }
                        }
                    }
                }
            }
        });
    }

    // ===== FUNGSI LOAD DATA (Tidak ada perubahan) =====
    async function loadDataFromSheets() {
        try {
            document.getElementById('tableContainer').innerHTML = `<div class="loading">${translations[currentLanguage].loadingMessage}</div>`;
            
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
            if (!response.ok) throw new Error('Failed to fetch data from the server');
            
            const data = await response.json();
            
            tableRowsAll = data.values.slice(1).filter(row => row[1] !== "-" && row[2] !== "-");
            
            processData(data.values);
            
            document.getElementById('lastUpdated').textContent = `${translations[currentLanguage].lastUpdatedPrefix} ${moment().format('LLLL')}`;
            
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('tableContainer').innerHTML = `<div class="loading">Error: ${error.message}. Please ensure a stable internet connection.</div>`;
        }
    }

    // ===== FUNGSI PROCESS DATA (Menggunakan array 'tableRowsAll' dan filter) =====
    function processData(data) {
        if (!data || data.length < 2) {
            document.getElementById('tableContainer').innerHTML = `<div class="loading">${currentLanguage === 'id' ? 'Tidak ada data produksi ditemukan' : 'No production data found'}</div>`;
            return;
        }
        
        tableHeaders = [
            translations[currentLanguage].tableHeader0,
            translations[currentLanguage].tableHeader1,
            translations[currentLanguage].tableHeader2,
            translations[currentLanguage].tableHeader3
        ];
        
        const rawRows = tableRowsAll; 

        // 1. TAHAP FILTER BERDASARKAN RANGE TANGGAL
        let filteredRows;

        if (filterStartDate && filterEndDate) {
            filteredRows = rawRows.filter(row => {
                const rowMoment = moment(row[0]);
                return rowMoment.isSameOrAfter(filterStartDate) && rowMoment.isSameOrBefore(filterEndDate);
            });
        } else {
            filteredRows = rawRows;
        }

        const rows = filteredRows;
        
        currentPage = 1;
        renderTable();

        // 2. PERHITUNGAN STATISTIK
        const chartData = [];
        let totalCycleTime = 0;
        let minCycleTime = Infinity;
        let maxCycleTime = 0;
        let totalCycles = 0;
        let todayCycles = 0;
        let lowerCount = 0, normalCount = 0, overCount = 0;
        let lastCycleTime = 0;
        let lastCycleStatus = '';
        
        rows.forEach((row, idx) => {
            const cycleTime = parseFloat(row[2]) || 0;
            const timestamp = row[0] || '';
            
            const isToday = moment(timestamp).isSame(moment(), 'day');
            
            if (!isNaN(cycleTime)) {
                chartData.push({ label: timestamp, value: cycleTime });
                totalCycleTime += cycleTime;
                totalCycles++;
                if (cycleTime < minCycleTime) minCycleTime = cycleTime;
                if (cycleTime > maxCycleTime) maxCycleTime = cycleTime;
                
                if (cycleTime < LOWER_LIMIT) lowerCount++;
                else if (cycleTime > UPPER_LIMIT) overCount++;
                else normalCount++;
                
                if (isToday) todayCycles++;
                if (idx === rows.length - 1) {
                    lastCycleTime = cycleTime;
                    lastCycleStatus = statusFromCycle(cycleTime);
                }
            }
        });

        const avgCycleTime = totalCycles > 0 ? totalCycleTime / totalCycles : 0;
        document.getElementById('avgCycleTime').textContent = isNaN(avgCycleTime) ? '0.00s' : avgCycleTime.toFixed(2) + 's';
        document.getElementById('totalCycles').textContent = totalCycles;
        document.getElementById('minCycleTime').textContent = isFinite(minCycleTime) ? minCycleTime.toFixed(2) + 's' : '0.00s';
        document.querySelector('[data-key="statMaxCycle"]').textContent = `${translations[currentLanguage].statMaxCycle} ${isFinite(maxCycleTime) ? maxCycleTime.toFixed(2) + 's' : '0.00s'}`;
        document.querySelector('[data-key="statToday"]').textContent = `${translations[currentLanguage].statToday} ${todayCycles}`;


        document.getElementById('lastCycleTime').textContent = lastCycleTime.toFixed(2) + 's';
        
        const statusElement = document.getElementById('lastCycleStatus');
        const displayStatus = translations[currentLanguage]['status' + lastCycleStatus.charAt(0).toUpperCase() + lastCycleStatus.slice(1).toLowerCase()];

        statusElement.textContent = `${translations[currentLanguage].statStatusPrefix} ${displayStatus}`;
        if (lastCycleStatus === 'NORMAL') statusElement.style.color = '#2ecc71';
        else if (lastCycleStatus === 'LOWER') statusElement.style.color = '#ffa500';
        else statusElement.style.color = '#e74c3c';
        
        updateCharts(chartData, lowerCount, normalCount, overCount);
    }
    
    // ===== FUNGSI UPDATE CHART (Diperbarui dengan LOWER/UPPER LIMIT dari variabel 'let') =====
    function updateCharts(chartData, lowerCount, normalCount, overCount) {
        const lang = currentLanguage;
        const total = lowerCount + normalCount + overCount;

        const recentChartData = chartData.slice(-50);
        cycleTimeChart.data.labels = recentChartData.map((_, index) => `${translations[lang].cycleLabel} ${index + 1}`);
        cycleTimeChart.data.datasets[0].data = recentChartData.map(item => item.value);
        
        // Memastikan label limit di update sesuai nilai baru
        cycleTimeChart.data.datasets[1].label = translations[lang].limitLower + ` (${LOWER_LIMIT.toFixed(2)}s)`;
        cycleTimeChart.data.datasets[2].label = translations[lang].limitUpper + ` (${UPPER_LIMIT.toFixed(2)}s)`;

        cycleTimeChart.data.datasets[1].data = Array(recentChartData.length).fill(LOWER_LIMIT);
        cycleTimeChart.data.datasets[2].data = Array(recentChartData.length).fill(UPPER_LIMIT);
        cycleTimeChart.update();
        
        statusChart.data.datasets[0].data = [lowerCount, normalCount, overCount];
        
        const labels = [
            translations[lang].statusLower,
            translations[lang].statusNormal,
            translations[lang].statusOver
        ];

        statusChart.data.labels = [
            `${labels[0]}: ${lowerCount} (${total > 0 ? ((lowerCount / total) * 100).toFixed(1) : 0}%)`,
            `${labels[1]}: ${normalCount} (${total > 0 ? ((normalCount / total) * 100).toFixed(1) : 0}%)`,
            `${labels[2]}: ${overCount} (${total > 0 ? ((overCount / total) * 100).toFixed(1) : 0}%)`
        ];
        
        statusChart.update();
    }

    // ===== FUNGSI STATUS DARI CYCLE (Tidak ada perubahan) =====
    function statusFromCycle(cycleTime) {
        if (cycleTime < LOWER_LIMIT) return 'LOWER';
        if (cycleTime > UPPER_LIMIT) return 'OVER';
        return 'NORMAL';
    }

    // ===== FUNGSI RENDER TABLE (Tidak ada perubahan) =====
    function renderTable(resetSort = true) {
        const rowsToRender = (filterStartDate || filterEndDate) 
                            ? tableRowsAll.filter(row => moment(row[0]).isSameOrAfter(filterStartDate) && moment(row[0]).isSameOrBefore(filterEndDate))
                            : tableRowsAll;

        if (!rowsToRender.length) {
            document.getElementById('tableContainer').innerHTML = `<div class="loading">${currentLanguage === 'id' ? 'Tidak ada data ditemukan dalam periode ini.' : 'No data found in this period.'}</div>`;
            document.getElementById('pagination').innerHTML = '';
            return;
        }

        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        let filtered = rowsToRender.filter(r => {
            const status = statusFromCycle(parseFloat(r[2]) || 0);
            const displayStatus = translations[currentLanguage]['status' + status.charAt(0).toUpperCase() + status.slice(1).toLowerCase()];

            return r[0].toLowerCase().includes(search) || 
                   r[2].toLowerCase().includes(search) ||
                   displayStatus.toLowerCase().includes(search);
        });

        if (currentSortIndex !== null && filtered.length > 0) {
            const columnIndex = currentSortIndex;
            const direction = sortDirection === 'asc' ? 1 : -1;
            
            filtered.sort((a, b) => {
                let valA = a[columnIndex];
                let valB = b[columnIndex];

                if (columnIndex === 0) {
                    return direction * (moment(valA).valueOf() - moment(valB).valueOf());
                } else if (columnIndex === 2) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return direction * (valA - valB);
                } else {
                    if (valA < valB) return direction * -1;
                    if (valA > valB) return direction * 1;
                    return 0;
                }
            });
        }

        rowsPerPage = parseInt(document.getElementById('rowsPerPage').value, 10);
        const totalPages = Math.max(1, Math.ceil(filtered.length / rowsPerPage));
        if (currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * rowsPerPage;
        const pageRows = filtered.slice(start, start + rowsPerPage);

        let tableHTML = `
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            ${tableHeaders.map((h, i) => {
                                const arrow = currentSortIndex === i ? (sortDirection === 'asc' ? '▲' : '▼') : '';
                                return `<th onclick="handleSort(${i})">${h}<span class="sort-indicator">${arrow}</span></th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${pageRows.map(row => {
                            const cycleTime = parseFloat(row[2]) || 0;
                            const status = statusFromCycle(cycleTime);
                            const displayStatus = translations[currentLanguage]['status' + status.charAt(0).toUpperCase() + status.slice(1).toLowerCase()];
                            
                            return `
                                <tr>
                                    <td>${moment(row[0]).format('DD/MM/YYYY HH:mm:ss')}</td>
                                    <td>${row[1]}</td>
                                    <td>${cycleTime.toFixed(2)}s</td>
                                    <td><span class="status-badge status-${status.toLowerCase()}">${displayStatus}</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        let pagHTML = '';
        const maxPagesToShow = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage + 1 < maxPagesToShow) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        if (currentPage > 1) {
            pagHTML += `<button onclick="goToPage(1)">&laquo;</button>`;
            pagHTML += `<button onclick="goToPage(${currentPage - 1})">&lsaquo;</button>`;
        }

        for (let i = startPage; i <= endPage; i++) {
            const activeClass = i === currentPage ? 'active' : '';
            pagHTML += `<button class="${activeClass}" onclick="goToPage(${i})">${i}</button>`;
        }

        if (currentPage < totalPages) {
            pagHTML += `<button onclick="goToPage(${currentPage + 1})">&rsaquo;</button>`;
            pagHTML += `<button onclick="goToPage(${totalPages})">&raquo;</button>`;
        }

        document.getElementById('tableContainer').innerHTML = tableHTML;
        document.getElementById('pagination').innerHTML = pagHTML;
    }

    // ===== FUNGSI SORTING/PAGINATION/EXPORT (Tidak ada perubahan) =====
    function handleSort(columnIndex) {
        if (currentSortIndex === columnIndex) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            currentSortIndex = columnIndex;
            sortDirection = 'asc';
        }
        currentPage = 1;
        renderTable(false); 
    }

    function goToPage(p) {
        currentPage = p;
        renderTable(false);
    }
    
    function exportCurrentToCSV() {
        const rowsToExport = (filterStartDate || filterEndDate) 
                            ? tableRowsAll.filter(row => moment(row[0]).isSameOrAfter(filterStartDate) && moment(row[0]).isSameOrBefore(filterEndDate))
                            : tableRowsAll;
        
        if (rowsToExport.length === 0) {
            alert(currentLanguage === 'id' ? "Tidak ada data untuk di-export." : "No data to export.");
            return;
        }

        const search = (document.getElementById('searchInput').value || '').toLowerCase();
        let filtered = rowsToExport.filter(r => {
            const status = statusFromCycle(parseFloat(r[2]) || 0);
            const displayStatus = translations[currentLanguage]['status' + status.charAt(0).toUpperCase() + status.slice(1).toLowerCase()];
            return r[0].toLowerCase().includes(search) || 
                   r[2].toLowerCase().includes(search) ||
                   displayStatus.toLowerCase().includes(search);
        });

        if (currentSortIndex !== null) {
             const columnIndex = currentSortIndex;
             const direction = sortDirection === 'asc' ? 1 : -1;
            
             filtered.sort((a, b) => {
                 let valA = a[columnIndex];
                 let valB = b[columnIndex];

                 if (columnIndex === 0) { 
                     return direction * (moment(valA).valueOf() - moment(valB).valueOf());
                 } else if (columnIndex === 2) { 
                     valA = parseFloat(valA) || 0;
                     valB = parseFloat(valB) || 0;
                     return direction * (valA - valB);
                 } else { 
                     if (valA < valB) return direction * -1;
                     if (valA > valB) return direction * 1;
                     return 0;
                 }
             });
        }
        
        const csvHeaders = [
            translations[currentLanguage].tableHeader0,
            translations[currentLanguage].tableHeader1,
            translations[currentLanguage].tableHeader2,
            translations[currentLanguage].tableHeader3
        ];
        let csv = csvHeaders.join(',') + '\n';

        filtered.forEach(r => { 
            const cycleTime = parseFloat(r[2]) || 0;
            const status = statusFromCycle(cycleTime);
            const displayStatus = translations[currentLanguage]['status' + status.charAt(0).toUpperCase() + status.slice(1).toLowerCase()];
            csv += `"${r[0]}", "${r[1]}", "${cycleTime.toFixed(2)}s", "${displayStatus}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data_cycle_time_${moment().format('YYYYMMDD_HHmmss')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
    // ===== END FUNGSI SORTING/PAGINATION/EXPORT =====

    // ===== FUNGSI ADMIN (SIMULASI) BARU =====
    function updateLimits(newLower, newUpper) {
        // PERINGATAN: Di lingkungan nyata, ini HARUS memanggil API server 
        // yang mengamankan dan menyimpan nilai ini secara permanen.

        LOWER_LIMIT = newLower;
        UPPER_LIMIT = newUpper;
        
        // Setelah batas berubah, proses ulang data untuk update tampilan chart/statistik
        if (tableRowsAll.length > 0) {
            processData(tableRowsAll); 
        }
    }

    function resetAllData() {
        // PERINGATAN: Di lingkungan nyata, ini HARUS memanggil API server / Google Apps Script
        // yang memiliki izin tulis untuk menghapus data di Google Sheet Anda.

        alert(currentLanguage === 'id' ? "Fungsi reset hanya simulasi. Perlu API tulis ke Google Sheets untuk implementasi penuh." : "Reset function is a simulation. Full write API needed to Google Sheets.");
        
        // Pilihan: Anda bisa memuat ulang data di sini jika API Reset dipanggil
        // loadDataFromSheets(); 
    }
    // ===== END FUNGSI ADMIN (SIMULASI) BARU =====
    </script>
</body>
</html>
